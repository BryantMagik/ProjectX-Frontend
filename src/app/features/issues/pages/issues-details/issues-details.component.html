<section class="issues-details-page">
  <header class="hero">
    <div class="hero-copy">
      <p class="eyebrow">Issue details</p>
      <h1>{{ issue?.summary || 'Detalle de issue' }}</h1>
      <p class="subtext">Consulta y actualiza la información del issue seleccionado desde la vista de issues.</p>
      <div class="hero-actions">
        <button class="btn ghost" type="button" (click)="navigateToIssues()">
          <i class="pi pi-arrow-left"></i>
          Volver
        </button>
        <button class="btn primary" type="button" (click)="toggleEdit()" [disabled]="!issue || loading">
          <i class="pi" [ngClass]="isEditing ? 'pi-times' : 'pi-pencil'"></i>
          {{ isEditing ? 'Cancelar edición' : 'Editar issue' }}
        </button>
      </div>
    </div>

    <div class="hero-panel">
      <div class="kpi">
        <span class="kpi-label">Código</span>
        <span class="kpi-value">{{ issue?.code || '-' }}</span>
      </div>
      <div class="kpi">
        <span class="kpi-label">Estado</span>
        <span class="task-status" [ngClass]="getStatusClass(issue?.status)">{{ issue?.status || '-' }}</span>
      </div>
      <div class="kpi">
        <span class="kpi-label">Prioridad</span>
        <span class="task-priority" [ngClass]="getPriorityClass(issue?.priority)">{{ issue?.priority || '-' }}</span>
      </div>
      <div class="kpi">
        <span class="kpi-label">Reporter</span>
        <span class="kpi-value reporter">{{ issue?.reporter?.first_name || 'Sin reporter' }}</span>
      </div>
    </div>
  </header>

  @if (loading) {
    <div class="state-card">
      <div class="spinner"></div>
      <p>Cargando issue...</p>
    </div>
  } @else if (error) {
    <div class="state-card error">
      <i class="pi pi-exclamation-circle"></i>
      <p>{{ error }}</p>
    </div>
  } @else if (issue) {
    <section class="panel">
      <form [formGroup]="issuesFormular" (ngSubmit)="onSubmit()" class="form-grid">
        <div class="form-section">
          <label class="form-label" for="issue-code">Código</label>
          <input id="issue-code" type="text" class="form-input readonly" formControlName="code" readonly />
        </div>

        <div class="form-section">
          <label class="form-label" for="issue-type">Tipo</label>
          <select id="issue-type" class="form-select" formControlName="type">
            @for (type of issueTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
        </div>

        <div class="form-section full-width">
          <label class="form-label" for="issue-summary">Resumen</label>
          <input id="issue-summary" type="text" class="form-input" formControlName="summary" />
        </div>

        <div class="form-section full-width">
          <label class="form-label" for="issue-description">Descripción</label>
          <textarea id="issue-description" rows="4" class="form-textarea" formControlName="description"></textarea>
        </div>

        <div class="form-section">
          <label class="form-label" for="issue-priority">Prioridad</label>
          <select id="issue-priority" class="form-select" formControlName="priority">
            @for (priority of taskPriorities; track priority) {
              <option [value]="priority">{{ priority }}</option>
            }
          </select>
        </div>

        <div class="form-section">
          <label class="form-label" for="issue-status">Estado</label>
          <select id="issue-status" class="form-select" formControlName="status">
            @for (status of issueStatuses; track status) {
              <option [value]="status">{{ status }}</option>
            }
          </select>
        </div>

        <div class="form-section">
          <label class="form-label" for="issue-assigned">Asignados</label>
          <p-multiSelect
            id="issue-assigned"
            formControlName="assignedTo"
            [options]="availableAssigneds"
            optionLabel="first_name"
            optionValue="id"
            placeholder="Selecciona usuarios"
            appendTo="body"
            styleClass="multiselect">
          </p-multiSelect>
        </div>

        <div class="form-section">
          <label class="form-label" for="issue-reporter">Reportado por</label>
          <input id="issue-reporter" type="text" class="form-input readonly" formControlName="reporter" readonly />
        </div>

        <div class="form-actions full-width">
          <button class="btn ghost" type="button" (click)="toggleEdit()" [disabled]="!isEditing">Cancelar</button>
          <button class="btn primary" type="submit" [disabled]="!isEditing || issuesFormular.invalid || saving">
            <i class="pi pi-check"></i>
            {{ saving ? 'Guardando...' : 'Guardar cambios' }}
          </button>
        </div>
      </form>
    </section>

    <section class="panel">
      <h3 class="comments-title">Comentarios</h3>
      <app-comments-list-component [issueId]="issueId || undefined"></app-comments-list-component>
    </section>
  }
</section>

<section class="members">
  <header class="hero">
    <div class="hero-copy">
      <p class="eyebrow">Workspace</p>
      <h1>Members</h1>
      <p class="subtext">Gestiona miembros, roles e invitaciones en un solo lugar.</p>
      <div class="hero-actions">
        <button (click)="openInviteModal()" class="btn primary">
          <i class="pi pi-user-plus"></i>
          Invitar miembros
        </button>
      </div>
    </div>
    <div class="hero-panel">
      <div class="panel-row">
        <div class="kpi">
          <span class="kpi-label">Total</span>
          <span class="kpi-value">{{ getMemberCount() }}</span>
          <span class="kpi-meta">Miembros</span>
        </div>
        <div class="kpi">
          <span class="kpi-label">Owners</span>
          <span class="kpi-value">{{ owners.length }}</span>
          <span class="kpi-meta">Responsables</span>
        </div>
      </div>
      <div class="panel-row">
        <div class="kpi success">
          <span class="kpi-label">Invitaciones</span>
          <span class="kpi-value">{{ getActiveInvitationsCount() }}</span>
          <span class="kpi-meta">Activas</span>
        </div>

        @if (invitations.length > 0) {
          <div class="kpi danger">
            <span class="kpi-label">Pendientes</span>
            <span class="kpi-value">{{ invitations.length }}</span>
            <span class="kpi-meta">En espera</span>
          </div>
        } @else {
          <div class="kpi">
            <span class="kpi-label">Pendientes</span>
            <span class="kpi-value">0</span>
            <span class="kpi-meta">Sin pendientes</span>
          </div>
        }
      </div>
    </div>
  </header>

  @if (loading) {
    <div class="state-card">
      <i class="pi pi-spin pi-spinner"></i>
      <p>Cargando miembros...</p>
    </div>
  }

  @if (error) {
    <div class="state-card error">
      <i class="pi pi-exclamation-triangle"></i>
      <p>{{ error }}</p>
    </div>
  }

  @if (!loading && !error) {
    @if (creator) {
      <section class="panel section">
        <div class="panel-header">
          <h2>Workspace Creator</h2>
          <span class="chip accent">Owner</span>
        </div>
        <div class="member-card creator-card">
          <div class="member-avatar">
            @if (creator.profile_picture) {
              <img [src]="creator.profile_picture" alt="{{creator.first_name}} {{creator.last_name}}" />
            } @else {
              <span>{{ creator.first_name[0] }}{{ creator.last_name[0] }}</span>
            }
          </div>
          <div class="member-info">
            <p class="member-name">{{ creator.first_name }} {{ creator.last_name }}</p>
            <p class="member-email">{{ creator.email }}</p>
          </div>
          <span class="badge badge-creator">Creator</span>
        </div>
      </section>
    }

    @if (owners.length > 0) {
      <section class="panel section">
        <div class="panel-header">
          <h2>Owners</h2>
          <span class="chip">{{ owners.length }}</span>
        </div>
        <div class="members-grid">
          @for (owner of owners; track owner.id) {
            <div class="member-card">
              <div class="member-avatar">
                @if (owner.profile_picture) {
                  <img [src]="owner.profile_picture" alt="{{owner.first_name}} {{owner.last_name}}" />
                } @else {
                  <span>{{ owner.first_name[0] }}{{ owner.last_name[0] }}</span>
                }
              </div>
              <div class="member-info">
                <p class="member-name">{{ owner.first_name }} {{ owner.last_name }}</p>
                <p class="member-email">{{ owner.email }}</p>
              </div>
              <div class="member-actions">
                <span class="badge badge-owner">Owner</span>
                @if (isCreator()) {
                  <button
                    (click)="removeMember(owner.id, owner.first_name + ' ' + owner.last_name)"
                    class="btn-remove"
                    title="Eliminar del workspace">
                    <i class="pi pi-trash"></i>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </section>
    }

    @if (members.length > 0) {
      <section class="panel section">
        <div class="panel-header">
          <h2>Members</h2>
          <span class="chip">{{ members.length }}</span>
        </div>
        <div class="members-grid">
          @for (member of members; track member.id) {
            <div class="member-card">
              <div class="member-avatar">
                @if (member.profile_picture) {
                  <img [src]="member.profile_picture" alt="{{member.first_name}} {{member.last_name}}" />
                } @else {
                  <span>{{ member.first_name[0] }}{{ member.last_name[0] }}</span>
                }
              </div>
              <div class="member-info">
                <p class="member-name">{{ member.first_name }} {{ member.last_name }}</p>
                <p class="member-email">{{ member.email }}</p>
              </div>
              <div class="member-actions">
                <span class="badge badge-member">Member</span>
                @if (isCreator()) {
                  <button
                    (click)="removeMember(member.id, member.first_name + ' ' + member.last_name)"
                    class="btn-remove"
                    title="Eliminar del workspace">
                    <i class="pi pi-trash"></i>
                  </button>
                }
              </div>
            </div>
          }
        </div>
      </section>
    }

    @if (invitations.length > 0) {
      <section class="panel section">
        <div class="panel-header">
          <h2>Invitaciones</h2>
          <span class="chip success">{{ invitations.length }}</span>
        </div>
        <div class="invitations-list">
          @for (invitation of invitations; track invitation.id) {
            <div class="invitation-card" [class.invitation-inactive]="!isInvitationActive(invitation)">
              <div class="invitation-info">
                <div class="invitation-header">
                  <span class="invitation-code">{{ invitation.code }}</span>
                  @if (isInvitationActive(invitation)) {
                    <span class="status-badge status-active">Active</span>
                  } @else {
                    <span class="status-badge status-inactive">{{ getInvitationStatus(invitation) }}</span>
                  }
                </div>
                <p class="invitation-meta">
                  Created by {{ invitation.author.first_name }} {{ invitation.author.last_name }}
                </p>
                <div class="invitation-stats">
                  <span>
                    <i class="pi pi-users mr-1"></i>
                    Uses: {{ invitation.uses }}@if (invitation.maxUses) { / {{ invitation.maxUses }} }
                  </span>
                  @if (invitation.expiresAt) {
                    <span>
                      <i class="pi pi-calendar mr-1"></i>
                      Expires: {{ invitation.expiresAt | date:'short' }}
                    </span>
                  }
                </div>
              </div>
              @if (isInvitationActive(invitation)) {
                <button
                  (click)="deactivateInvitation(invitation.id)"
                  class="btn-deactivate"
                  title="Deactivate invitation">
                  <i class="pi pi-ban"></i>
                </button>
              }
            </div>
          }
        </div>
      </section>
    }
  }
</section>

@if (showInviteModal) {
  <div class="modal-overlay" (click)="closeInviteModal()" (keydown.escape)="closeInviteModal()" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-content" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" tabindex="-1">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">Generate Invitation Link</h3>
        <button (click)="closeInviteModal()" class="modal-close" title="Close modal" aria-label="Close modal">
          <i class="pi pi-times"></i>
        </button>
      </div>

      @if (!generatedLink) {
        <div class="modal-body">
          <div class="form-group">
            <label for="maxUses" class="form-label">
              <i class="pi pi-users mr-2"></i>
              Maximum Uses (Optional)
            </label>
            <input
              id="maxUses"
              type="number"
              [(ngModel)]="maxUses"
              placeholder="Unlimited"
              min="1"
              class="form-input"
              aria-label="Maximum uses for invitation"
            />
          </div>

          <div class="form-group">
            <label for="expiresInDays" class="form-label">
              <i class="pi pi-calendar mr-2"></i>
              Expires in Days (Optional)
            </label>
            <input
              id="expiresInDays"
              type="number"
              [(ngModel)]="expiresInDays"
              placeholder="Never expires"
              min="1"
              class="form-input"
              aria-label="Expires in days"
            />
          </div>
        </div>

        <div class="modal-footer">
          <button (click)="closeInviteModal()" class="btn-cancel">
            Cancel
          </button>
          <button (click)="generateInviteLink()" class="inline-flex items-center gap-2 px-4 py-2 rounded-xl font-semibold text-white bg-gradient-to-br from-blue-500 to-indigo-500 border border-blue-500/50 cursor-pointer">
            <i class="pi pi-link"></i>
            Generate Link
          </button>
        </div>
      } @else {
        <div class="modal-body">
          <div class="link-generated">
            <i class="pi pi-check-circle text-green-500 text-4xl mb-4"></i>
            <p class="text-slate-700 font-semibold mb-2">Invitation link generated!</p>
            <p class="text-slate-500 text-sm mb-4">Share this link with people you want to invite</p>

            <div class="link-display">
              <input
                type="text"
                [value]="generatedLink"
                readonly
                class="link-input"
                aria-label="Generated invitation link"
                aria-readonly="true"
              />
              <button (click)="copyInviteLink()" class="btn-copy">
                @if (linkCopied) {
                  <i class="pi pi-check mr-2"></i>
                  Copied!
                } @else {
                  <i class="pi pi-copy mr-2"></i>
                  Copy
                }
              </button>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button (click)="closeInviteModal()" class="btn-done">
            Done
          </button>
        </div>
      }
    </div>
  </div>
}

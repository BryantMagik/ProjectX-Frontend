<section class="mytasks">
  <header class="hero">
    <div class="hero-copy">
      <p class="eyebrow">My Tasks</p>
      <h1>Mis tareas</h1>
      <p class="subtext">Prioriza, filtra y ejecuta. Todo en un solo lugar.</p>
      <div class="hero-actions">
        <button class="btn primary" (click)="openCreateTaskModal()">
          <i class="pi pi-plus"></i>
          Nueva tarea
        </button>
        <button class="btn ghost" (click)="toggleKanban()">
          <i class="pi pi-th-large"></i>
          {{ showKanban ? 'Ver lista' : 'Ver tablero' }}
        </button>
      </div>
    </div>
    <div class="hero-panel">
      <div class="panel-row">
        <div class="kpi">
          <span class="kpi-label">Total</span>
          <span class="kpi-value">{{ filteredTasks.length }}</span>
          <span class="kpi-meta">Tareas visibles</span>
        </div>
        <div class="kpi">
          <span class="kpi-label">Activas</span>
          <span class="kpi-value">{{ getActiveTasksCount() }}</span>
          <span class="kpi-meta">En progreso</span>
        </div>
      </div>
      <div class="panel-row">
        <div class="kpi success">
          <span class="kpi-label">Completadas</span>
          <span class="kpi-value">{{ getCompletedTasksCount() }}</span>
          <span class="kpi-meta">Finalizadas</span>
        </div>
        <div class="kpi danger">
          <span class="kpi-label">Alta prioridad</span>
          <span class="kpi-value">{{ getHighPriorityTasksCount() }}</span>
          <span class="kpi-meta">Revisar hoy</span>
        </div>
      </div>
    </div>
  </header>

  <section class="filters panel">
    <div class="search-box">
      <i class="pi pi-search search-icon"></i>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (ngModelChange)="onSearchChange()"
        placeholder="Buscar por código o resumen..."
        class="search-input"
      />
    </div>
    <div class="filter-group">
      <select
        [(ngModel)]="selectedStatus"
        (ngModelChange)="onStatusChange()"
        class="filter-select"
        title="Filtrar por estado">
        <option value="all">Todos los estados</option>
        <option value="Active">Active</option>
        <option value="Ongoing">Ongoing</option>
        <option value="Completed">Completed</option>
        <option value="Inactive">Inactive</option>
      </select>

      <select
        [(ngModel)]="selectedPriority"
        (ngModelChange)="onPriorityChange()"
        class="filter-select"
        title="Filtrar por prioridad">
        <option value="all">Todas las prioridades</option>
        <option value="high">High</option>
        <option value="medium">Medium</option>
        <option value="low">Low</option>
      </select>
    </div>
  </section>

  <section class="stats-grid">
    <article class="stat-card">
      <div class="stat-header">
        <h3>Total tareas</h3>
        <span class="chip">Global</span>
      </div>
      <div class="ring" style="--accent: #3b82f6;" [style.--percent]="100">
        <div class="ring-inner">
          <span class="ring-data">{{ filteredTasks.length }}</span>
          <span class="ring-percent">100%</span>
        </div>
      </div>
      <p class="stat-note">Visión del universo actual.</p>
    </article>

    <article class="stat-card">
      <div class="stat-header">
        <h3>Activas</h3>
        <span class="chip accent">En foco</span>
      </div>
      <div class="ring" style="--accent: #f59e0b;" [style.--percent]="getActiveTasksCount()">
        <div class="ring-inner">
          <span class="ring-data">{{ getActiveTasksCount() }}</span>
          <span class="ring-percent">Ahora</span>
        </div>
      </div>
      <p class="stat-note">Tareas que requieren avance.</p>
    </article>

    <article class="stat-card">
      <div class="stat-header">
        <h3>Completadas</h3>
        <span class="chip success">Salud</span>
      </div>
      <div class="ring" style="--accent: #10b981;" [style.--percent]="getCompletedTasksCount()">
        <div class="ring-inner">
          <span class="ring-data">{{ getCompletedTasksCount() }}</span>
          <span class="ring-percent">Done</span>
        </div>
      </div>
      <p class="stat-note">Cierre de trabajo.</p>
    </article>

    <article class="stat-card danger">
      <div class="stat-header">
        <h3>Alta prioridad</h3>
        <span class="chip danger">Riesgo</span>
      </div>
      <div class="ring" style="--accent: #ef4444;" [style.--percent]="getHighPriorityTasksCount()">
        <div class="ring-inner">
          <span class="ring-data">{{ getHighPriorityTasksCount() }}</span>
          <span class="ring-percent">High</span>
        </div>
      </div>
      <p class="stat-note">Revisar bloqueos.</p>
    </article>
  </section>

  <section class="list-section" [class.hidden]="showKanban">
    @if (loading) {
      <div class="state-card">
        <div class="spinner"></div>
        <p>Cargando tareas...</p>
      </div>
    }

    @if (error && !loading) {
      <div class="state-card error">
        <i class="pi pi-exclamation-circle"></i>
        <p>{{ error }}</p>
      </div>
    }

    @if (!loading && !error) {
      @if (filteredTasks.length === 0) {
        <div class="state-card">
          <i class="pi pi-inbox"></i>
          <h3>No hay tareas</h3>
          <p>{{ searchTerm || selectedStatus !== 'all' || selectedPriority !== 'all' ? 'Ajusta tus filtros para ver resultados.' : 'Crea tu primera tarea para empezar.' }}</p>
        </div>
      } @else {
        <div class="tasks-grid">
          @for (task of filteredTasks; track task.id) {
            <button class="task-card" (click)="navigateToTaskDetails(task.id)" title="Ver detalles" type="button">
              <div class="task-header">
                <span class="task-code">{{ task.code }}</span>
                <span class="task-priority" [ngClass]="getPriorityClass(task.priority)">
                  {{ task.priority }}
                </span>
              </div>
              <h3 class="task-title">{{ task.summary }}</h3>
              @if (task.description) {
                <p class="task-description">{{ task.description }}</p>
              }
              <div class="task-footer">
                <div class="task-meta">
                  <div class="meta-item">
                    <i class="pi pi-user"></i>
                    <span>{{ task.creator.first_name || 'Unassigned' }}</span>
                  </div>
                </div>
                <span class="task-status" [ngClass]="getStatusClass(task.status)">
                  {{ task.status }}
                </span>
              </div>
            </button>
          }
        </div>
      }
    }
  </section>

  <section class="board-section" [class.hidden]="!showKanban">
    <div class="board-header">
      <button class="btn ghost" (click)="toggleKanban()">
        <i class="pi pi-arrow-left"></i>
        Volver a lista
      </button>
    </div>
    <app-tasks-board></app-tasks-board>
  </section>

  @if (showProjectModal) {
    <div class="modal-backdrop" (click)="closeCreateTaskModal()" (keydown.escape)="closeCreateTaskModal()" role="presentation">
      <div class="modal-card" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()" role="dialog" aria-modal="true" tabindex="0">
        <div class="modal-header">
          <h3>Selecciona un proyecto</h3>
          <button class="btn ghost" type="button" aria-label="Cerrar modal" (click)="closeCreateTaskModal()">
            <i class="pi pi-times"></i>
          </button>
        </div>
        <p class="modal-subtext">Elige el proyecto donde deseas crear la nueva tarea.</p>
        <div class="modal-body">
          <label class="modal-label" for="modalProjectSelect">Proyecto</label>
          <select
            id="modalProjectSelect"
            class="filter-select"
            [(ngModel)]="selectedProjectId">
            <option [ngValue]="null">Selecciona un proyecto</option>
            @for (project of projects; track project.id) {
              <option [value]="project.id">{{ project.name }}</option>
            }
          </select>
        </div>
        <div class="modal-actions">
          <button class="btn ghost" type="button" (click)="closeCreateTaskModal()">Cancelar</button>
          <button class="btn primary" type="button" (click)="confirmCreateTask()" [disabled]="!selectedProjectId">
            Continuar
          </button>
        </div>
      </div>
    </div>
  }
</section>
